---

- name: install git
  apt:
    pkg: git
    state: latest

- name: Download
  git:
    repo: "{{ shaarli_git_url }}"
    version: "{{ shaarli_version }}"
    dest: /opt/shaarli
    force: yes
  notify: restart php

- name: Install dependencies
  composer:
    command: install
    working_dir: /opt/shaarli

- name: Configure
  template:
    owner: shaarli
    group: shaarli
    src: "{{ item }}"
    dest: "/{{ item }}"
  with_items:
    - opt/shaarli/data/config.json.php
    - opt/shaarli/data/updates.txt
  notify: restart php

- name: Set permission
  file:
    state: directory
    mode: 0755
    owner: shaarli
    path: "{{ item }}"
  with_items:
    - /opt/shaarli/cache
    - /opt/shaarli/data
    - /opt/shaarli/pagecache
    - /opt/shaarli/tmp

- name: Fetch datastore
  fetch:
    src: /opt/shaarli/data/datastore.php
    dest: "{{ shaarli_local_datastore }}"
    flat: yes
  when: shaarli_backup

- name: Upload local datastore
  copy:
    src: "{{ shaarli_local_datastore }}"
    dest: /opt/shaarli/data/datastore.php
    owner: shaarli
    group: shaarli
    mode: 0644
    backup: True
  when: shaarli_restore
